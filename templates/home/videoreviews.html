{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="our-clients-2 white-bg page-section-ptb" style="margin-top: 115px">
  <div class="container">

    <div class="row">
      <div class="col-lg-12 col-md-12">
        <div class="section-title-1 text-center">
          <h1 class="text-blue">Video Reviews</h1>
          <div class="title-line"></div>
        </div>
      </div>
    </div>

    {% if featured %}
      <div class="row mb-3">
        <div class="col-12">
          <h4 class="mb-3">Featured</h4>
        </div>
      </div>

      <!-- Featured masonry -->
      <div class="video-masonry" id="featuredMasonry">
        {% for v in featured %}
          <div class="video-item" data-video-wrap>
            <div class="video-card">
              <div class="video-media video-watermark-wrap">
                <video
                  class="video-el"
                  preload="metadata"
                  playsinline
                  controls
                  {% if v.thumbnail %}poster="{{ v.thumbnail.url }}"{% endif %}
                >
                  <source src="{{ v.video.url }}">
                  Your browser does not support the video tag.
                </video>

                <button type="button" class="play-overlay" data-play-btn aria-label="Play video">
                  <span class="play-triangle"></span>
                </button>
              </div>

              <div class="video-meta">
                <h5 class="mb-1">{{ v.title }}</h5>
                {% if v.customer_name %}
                  <div class="text-muted">{{ v.customer_name }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}



    <!-- Main masonry (paginated) -->
    <div class="video-masonry" id="videoGrid">
      {% include "home/partials/_video_cards.html" with page_obj=page_obj %}
    </div>

    <!-- Load more -->
    <div class="row">
      <div class="col-12 text-center mt-3">
        {% if page_obj.has_next %}
          <button
            id="loadMoreBtn"
            class="button button-black"
            data-next-page="{{ page_obj.next_page_number }}"
            type="button"
          >
            <span>Load More</span>
          </button>
        {% endif %}
      </div>
    </div>

  </div>
</section>

<section class="custom-content-7 bg-14 page-section-ptb">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 col-md-12 text-center">
        <a class="button button-black"  href="{% url 'copyright' %}"><span> Copyright Notice </span></a>
      </div>
    </div>
  </div>
</section>

<style>
/* ===== VIDEO WATERMARK (show only while playing) ===== */
.video-watermark-wrap{ position: relative; }

/* watermark hidden by default */
.video-watermark-wrap::after{
  content: "";
  position: absolute;
  bottom: 10px;
  right: 10px;

  width: 90px;
  height: 36px;  /* âœ… REQUIRED (otherwise it can be 0 height) */

  background: url("{% static 'images/watermark.png' %}") no-repeat center center;
  background-size: contain;

  opacity: 0;
  transform: translateY(2px);
  transition: opacity .2s ease, transform .2s ease;

  pointer-events: none;
  z-index: 5;
}

/* show watermark only when playing */
[data-video-wrap].is-playing .video-watermark-wrap::after{
  opacity: 0.28 !important;
  transform: translateY(0);
}

@media (max-width: 768px){
  .video-watermark-wrap::after{
    width: 70px;
    height: 28px;
    bottom: 8px;
    right: 8px;
  }
}
@media (max-width: 480px){
  .video-watermark-wrap::after{
    width: 55px;
    height: 22px;
  }
}
  /* Masonry layout that preserves original video aspect ratio */
  .video-masonry{
    column-gap: 18px;
    column-count: 3;
  }
  @media (max-width: 991px){
    .video-masonry{ column-count: 2; }
  }
  @media (max-width: 575px){
    .video-masonry{ column-count: 1; }
  }

  .video-item{
    break-inside: avoid;
    margin: 0 0 18px;
    width: 100%;
    display: inline-block;
  }

.video-card{
  border-radius: 16px;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
  transition: transform .25s ease, box-shadow .25s ease;
}

.video-card:hover{
  transform: translateY(-3px);
  box-shadow: 0 16px 35px rgba(0,0,0,.12);
}

  /* Thumbnail container */
.video-media{
  position: relative;
  background: #000;
  padding: 10px;                 /* breathing room */
}

/* Actual video / poster */
.video-el{
  width: 100%;
  height: auto;                  /* keep original ratio */
  max-height: 260px;             /* ðŸ”¥ makes thumbnails smaller */
  object-fit: contain;           /* never crop */
  background: #000;
  border-radius: 10px;
  display: block;
  margin: 0 auto;                /* center smaller videos */
}

  .video-meta{
    padding:14px 16px;
  }

  /* Play overlay */
  .play-overlay{
    position:absolute;
    inset:0;
    border:0;
    background:rgba(0,0,0,.25);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition: background .2s ease;
    z-index: 4;
  }
  .play-overlay:hover{ background:rgba(0,0,0,.35); }

  .play-triangle{
    width:0;height:0;
    border-top:18px solid transparent;
    border-bottom:18px solid transparent;
    border-left:28px solid #fff;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
    transform: translateX(2px);
  }

  /* Hide overlay once playing */
  [data-video-wrap].is-playing .play-overlay{
    opacity:0;
    pointer-events:none;
  }



</style>

<script>
  (function(){
    function initVideoOverlays(root){
      const wraps = (root || document).querySelectorAll("[data-video-wrap]");
      wraps.forEach(wrap => {
        const video = wrap.querySelector("video");
        const btn = wrap.querySelector("[data-play-btn]");
        if (!video || !btn) return;

        if (wrap.dataset.bound === "1") return;
        wrap.dataset.bound = "1";

        function play(){
          // pause other videos
          document.querySelectorAll("video.video-el").forEach(v => {
            if (v !== video) {
              v.pause();
              const w = v.closest("[data-video-wrap]");
              if (w) w.classList.remove("is-playing");
            }
          });

          wrap.classList.add("is-playing");
          video.play().catch(()=>{});
        }

        btn.addEventListener("click", play);

        video.addEventListener("play", () => wrap.classList.add("is-playing"));
        video.addEventListener("pause", () => wrap.classList.remove("is-playing"));
        video.addEventListener("ended", () => wrap.classList.remove("is-playing"));
      });
    }

    async function loadMore(){
      const btn = document.getElementById("loadMoreBtn");
      if (!btn) return;

      btn.disabled = true;
      const nextPage = btn.getAttribute("data-next-page");

      try{
        const res = await fetch(`?page=${encodeURIComponent(nextPage)}`, {
          headers: {"X-Requested-With": "XMLHttpRequest"}
        });
        if (!res.ok) throw new Error("Failed to load");

        const html = await res.text();

        const grid = document.getElementById("videoGrid");
        const temp = document.createElement("div");
        temp.innerHTML = html;

        // read marker BEFORE moving nodes out
        const marker = temp.querySelector("[data-has-next]");
        const hasNext = marker && marker.getAttribute("data-has-next") === "1";
        const next = marker ? marker.getAttribute("data-next-page") : null;
        if (marker) marker.remove();

        // append new items
        while (temp.firstChild) grid.appendChild(temp.firstChild);

        initVideoOverlays(grid);

        if (hasNext && next) {
          btn.setAttribute("data-next-page", next);
          btn.disabled = false;
        } else {
          btn.remove();
        }

      } catch(e) {
        btn.disabled = false;
        alert("Could not load more videos. Please try again.");
      }
    }

    document.addEventListener("DOMContentLoaded", function(){
      initVideoOverlays(document);
      const btn = document.getElementById("loadMoreBtn");
      if (btn) btn.addEventListener("click", loadMore);
    });
  })();
</script>

{% endblock %}